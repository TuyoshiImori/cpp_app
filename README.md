# CSAApp

## 概要
CSAAppは、SwiftUIを使用して開発されたiOSアプリケーションで、アンケートのスキャン、設問タイプの選択、画像処理、文字認識などの機能を提供します。以下に画面ごとの機能とアプリのフローを説明します。

---

## 画面ごとの機能

### 1. **ContentView**
- アプリのメイン画面。
- 保存されたアンケートデータ（`Item`）のリストを表示。
- 各アイテムにはタイムスタンプと選択された設問タイプが表示される。
- アイテムをタップするとカメラ画面（`CameraView`）が開く。

### 2. **CameraView**
- カメラプレビューを表示し、リアルタイムで矩形検出を行う。
- 自動キャプチャ機能を提供し、検出された画像を保存。
- キャプチャした画像を加工（グレースケール変換、円検出、切り取り）し、プレビュー表示。
- サンプル画像を読み込む機能を提供。
- キャプチャした画像のプレビューを全画面表示可能。

---

## 機能のフロー

1. **アンケートのスキャン**
   - `ContentView`でアイテムをタップして`CameraView`を開く。
   - カメラプレビューでアンケート用紙をスキャン。
   - 自動キャプチャで画像を取得（手動キャプチャ機能を実装するかは要検討）。
   - 取得した画像を加工し、切り取られた設問画像をプレビュー。

2. **画像処理と文字認識**
   - OpenCVを使用して画像を加工（リサイズ、グレースケール、二値化、ノイズ除去など）。
   - 円検出を行い、設問ごとに画像を切り取り。
   - Visionフレームワークを使用して文字認識を実施。

3. **プレビューと確認**
   - キャプチャした画像や切り取られた設問画像をプレビュー。
   - 必要に応じて再スキャンや再開を実行。

---

## 使用技術
- **SwiftUI**: UI構築
- **MVVMパターン**: アーキテクチャ
- **OpenCV**: 画像処理（円検出、ノイズ除去など）
- **Visionフレームワーク**: 文字認識
- **Combine**: データバインディングとリアクティブプログラミング
- **CoreGraphics**: 矩形検出と画像操作

---

## 今後の機能実装
- 画像を設問ごとに切り取ったあと、事前に選択した設問タイプの順番に解答内容を集計する。
- QRコードまたはID入力によるFirestoreからのアンケート情報取得機能の実装。

## チェックボックス設問の「その他」の自由回答の検出のフロー
1. チェックボックスの座標を全て検出
2. 座標を元に左上からindexを割り振る
3. 最後のindexがその他になる
4. 単数解答であればチェックがついている最初の選択肢の文字列を保持
5. 複数回答であればチェックがついている全ての選択肢の文字列を保持
6. その他にチェックがついているor全てのチェックボックスにチェックが付いていない場合にその他の（）内の文字検出を行う
7. その他のチェックボックス3つ分右の座標を割り出す（文字検出時にその他を入れないため）
8. 割り出した座標から上に少し、下にチェックボックスの高さと少し、右側を切り取る
9. 文字検出後の文字列から()を除外してその文字列を保持

## 回答検出フロー (single / multiple / text)

以下は実装側で使用している高レベルの検出フローの説明です。詳細実装は `OpenCVWrapper.mm` にあり、UI 側では `CameraView.swift` が結果を表示します。

共通の前処理
- 画像をグレースケール化し、ノイズ低減（Blur）を行う。
- 大津閾値（OTSU）などで二値化し、必要に応じて反転（白黒を反転）する。
- 円検出で設問ごとに切り出した小画像を入力として処理する（円検出・切り取りは既存処理に従う）。

single / multiple（チェックボックス検出）
- 目的: 各選択肢に対応するチェックボックス座標を検出し、選択有無を判定して文字列にマップする。
- 手順:
   1. 二値化結果から水平／垂直方向の線抽出を行う（モルフォロジー: カーネル幅 lWidth=2, 枠の太さに合わせた lineMinWidth=15 を使用）。
   2. 水平マスクと垂直マスクを合成して枠線マスクを作る。
   3. `connectedComponentsWithStats` で候補領域を抽出する。
   4. 幾何学的フィルタを適用（幅・高さ・面積・縁からの余白・概ね正方形など）してチェックボックス候補を絞る。
   5. 候補を上→左の順でソートしてインデックスを割り振る（左上基準で index を付ける）。
   6. 各候補の内部領域（枠内）を見て黒ピクセル比率を計算し、閾値以上ならチェックありと判断（isCheckboxChecked）。
   7. single なら最初に検出されたチェックを採用、multiple なら全チェックを採用して選択肢文字列にマップする。

text（自由記述の枠内文字検出）
- 目的: 設問内の矩形枠（長方形）を検出し、その内部を OCR して一行の文字列として返す。
- 手順:
   1. チェックボックス検出と同じ前処理（グレースケール、二値化、水平／垂直線抽出）を行う。枠の線幅はチェックボックスと同じなので `lineMinWidth=15` を使用する。
   2. 水平／垂直マスクを合成して枠線マスク（imgBinFinal）を作る。
   3. `findContours`（または接続成分）で輪郭／領域候補を抽出する。
   4. 候補に対して幾何学的フィルタを適用する（例: 幅 > 50, 高さ > 20, 面積 > 1000, 画像全体を占めない w < 0.95*cols 等、縦横比の緩い条件）。
   5. フィルタを通った候補の中から面積最大の矩形を選ぶ（ただし画像全体をそのまま選ばないように境界係数で除外する）。
   6. 選ばれた矩形の内側（少し余白を取って）を切り出し、`recognizeTextFromImage:`（Vision）で OCR を実行する。
   7. OCR 結果は改行を削除して 1 行にまとめる（`removeNewlinesFromText:` を使用）。
   8. 候補が見つからない場合は閾値を緩めるか、Hough 直線検出等の代替手法で再試行する。

実装上の主要シンボル／ファイル
- `OpenCVWrapper.mm`:
   - `detectCheckboxes`（チェックボックス検出のロジック）
   - `isCheckboxChecked`（チェック判定）
   - `detectTextAnswerFromImage:`（画像から自由記述を抽出するエントリ）
   - `detectLargestTextBox:`（枠検出関数、モルフォロジー→輪郭抽出→フィルタ）
   - `recognizeTextFromImage:`（Vision による OCR）
   - `removeNewlinesFromText:`（改行を削除して 1 行にする）
- `CameraView.swift`: 検出結果（text の場合の OCR 文字列）を UI に表示する部分を担当。

デバッグ・チューニングのヒント
- 実行ログには検出過程の情報が出力されるようにしています。デバッグ時は以下のログ文字列を探してください:
   - "OpenCVWrapper: detectLargestTextBox - binary nonZero="
   - "OpenCVWrapper: detectLargestTextBox - imgBinH nonZero="
   - "OpenCVWrapper: detectLargestTextBox - imgBinV nonZero="
   - "OpenCVWrapper: detectLargestTextBox - imgBinFinal nonZero="
   - "OpenCVWrapper: detectLargestTextBox - contourCount="
   - "OpenCVWrapper: detectLargestTextBox - contour="（個々の候補のフィルタ通過ログ）
- 枠が検出できない場合: `lineMinWidth`（枠の太さ）を入力画像の実際の線幅にあわせて調整する、または横/縦カーネルのサイズ（lWidth）を変えてみてください。
- connectedComponents が画像全体を返すケースでは `findContours` に切り替えて候補を絞ると安定することが多いです。

このセクションは今後のパラメータ調整や追加のフォールバックを記録するために更新していきます。

- infoの回答検出フロー
OpenCVを使用してStoredTypeがinfoの設問の回答検出を実装したい。
infoの回答欄はExcel形式の表になっている。
表は行が可変、列が2列で固定の構成になっている。
まずは表の一番外側の枠線を検出する。
textで使用している水平線と垂直線を検出して行うテキスト領域の検出方法を応用すること。
ここで検出した枠線内の文字や線だけを検出対象としたい。
次に左右で列を分割できるように、外側の枠線以外の垂直線を検出する。
表なので長さは枠線と同じ。
これで検出した垂直線より右側が記述欄なので、垂直線と外側の枠線でできた四角形の中から各行の文字を検出していく。
右列から水平線を検出する。このとき検出される水平線の本数はinfoの設問数+1と同じである。
一番上の水平線とその一つ下の水平線の間にある文字列が回答文となる。
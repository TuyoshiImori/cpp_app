# CSAApp

## 概要
CSAAppは、SwiftUIを使用して開発されたiOSアプリケーションで、アンケートのスキャン、設問タイプの選択、画像処理、文字認識などの機能を提供します。以下に画面ごとの機能とアプリのフローを説明します。

---

## 画面ごとの機能

### 1. **ContentView**
- アプリのメイン画面。
- 保存されたアンケートデータ（`Item`）のリストを表示。
- 各アイテムにはタイムスタンプと選択された設問タイプが表示される。
- アイテムをタップするとカメラ画面（`CameraView`）が開く。
 - 新しいアイテムは外部からの URL インポート（例: `myapp://import?...`）によって作成されます。

### 2. **CameraView**
- カメラプレビューを表示し、リアルタイムで矩形検出を行う。
- 自動キャプチャ機能を提供し、検出された画像を保存。
- キャプチャした画像を加工（グレースケール変換、円検出、切り取り）し、プレビュー表示。
- サンプル画像を読み込む機能を提供。
- キャプチャした画像のプレビューを全画面表示可能。

---

## 機能のフロー

1. **アンケートデータの作成**
   - Web 側でアンケートのフォーマット（設問文・選択肢）を作成し、所定のクエリフォーマットでアプリを開く URL（例: `myapp://import?...`）を用意する。
   - その URL でアプリを開くと、アプリ側でパースして `Item` が自動的に作成されます（設問文と選択肢を含む）。
   - 必要に応じて `CameraView` を開き、アンケート用紙のスキャンや画像処理を行います。

2. **アンケートのスキャン**
   - `ContentView`でアイテムをタップして`CameraView`を開く。
   - カメラプレビューでアンケート用紙をスキャン。
   - 自動キャプチャで画像を取得（手動キャプチャ機能を実装するかは要検討）。
   - 取得した画像を加工し、切り取られた設問画像をプレビュー。

3. **画像処理と文字認識**
   - OpenCVを使用して画像を加工（リサイズ、グレースケール、二値化、ノイズ除去など）。
   - 円検出を行い、設問ごとに画像を切り取り。
   - Visionフレームワークを使用して文字認識を実施。

4. **プレビューと確認**
   - キャプチャした画像や切り取られた設問画像をプレビュー。
   - 必要に応じて再スキャンや再開を実行。

---

## 使用技術
- **SwiftUI**: UI構築
- **MVVMパターン**: アーキテクチャ
- **OpenCV**: 画像処理（円検出、ノイズ除去など）
- **Visionフレームワーク**: 文字認識
- **Combine**: データバインディングとリアクティブプログラミング
- **CoreGraphics**: 矩形検出と画像操作

---

## 今後の機能実装
- URLにアンケートIDとタイトルを追加して、同じIDのアンケートが複数追加されないようにする
- 画像を設問ごとに切り取ったあと、事前に選択した設問タイプの順番に解答内容を集計する。

## URLの仕様
URLの例
myapp://import?id=12345&title=%E7%AC%AC10%E5%9B%9E%E5%AE%9A%E6%9C%9F%E6%BC%94%E5%A5%8F%E4%BC%9A%E3%82%A2%E3%83%B3%E3%82%B1%E3%83%BC%E3%83%88&single=%E3%81%8A%E5%AE%A2%E6%A7%98%E3%81%AE%E3%81%94%E5%B9%B4%E4%BB%A3%E3%82%92%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82%7C%5B%2210%E4%BB%A3%E6%9C%AA%E6%BA%80%22%2C%2210%E4%BB%A3%22%2C%2220%E4%BB%A3%22%2C%2230%E4%BB%A3%22%2C%2240%E4%BB%A3%22%2C%2250%E4%BB%A3%22%2C%2260%E4%BB%A3%22%2C%2270%E4%BB%A3%22%2C%2280%E4%BB%A3%E4%BB%A5%E4%B8%8A%22%2C%22%E3%81%9D%E3%81%AE%E4%BB%96%22%5D&multiple=%E6%9C%AC%E5%85%AC%E6%BC%94%E3%81%AF%E3%81%A9%E3%81%A1%E3%82%89%E3%81%A7%E3%81%8A%E7%9F%A5%E3%82%8A%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%97%E3%81%9F%E3%81%8B%EF%BC%9F%7C%5B%22%E3%83%9D%E3%82%B9%E3%82%BF%E3%83%BC%22%2C%22%E5%87%BA%E6%BC%94%E8%80%85%E3%81%8B%E3%82%89%22%2C%22SNS%28X%2CInstagram%2CFacebook%29%22%2C%22%E3%81%9D%E3%81%AE%E4%BB%96%22%5D&single=%E6%9C%AC%E5%85%AC%E6%BC%94%E3%81%AE%E6%BA%80%E8%B6%B3%E5%BA%A6%E3%82%925%E6%AE%B5%E9%9A%8E%E8%A9%95%E4%BE%A1%E3%81%A7%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%7C%5B%22%E5%A4%A7%E5%A4%89%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F%22%2C%22%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F%22%2C%22%E6%99%AE%E9%80%9A%22%2C%22%E8%89%AF%E3%81%8F%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%22%2C%22%E6%82%AA%E3%81%8B%E3%81%A3%E3%81%9F%22%5D&text=%E6%9C%AC%E6%97%A5%E3%81%AE%E3%81%94%E6%84%9F%E6%83%B3%E3%82%92%E3%81%8A%E8%81%9E%E3%81%8B%E3%81%9B%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%EF%BC%88%E5%8D%B0%E8%B1%A1%E3%81%AB%E6%AE%8B%E3%81%A3%E3%81%9F%E6%9B%B2%E3%80%81%E5%87%BA%E6%BC%94%E8%80%85%E3%81%B8%E3%81%AE%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%81%AA%E3%81%A9%EF%BC%89&text=%E6%94%B9%E5%96%84%E7%82%B9%E3%82%84%E3%82%AA%E3%83%BC%E3%82%B1%E3%82%B9%E3%83%88%E3%83%A9%E3%83%81%E3%82%A7%E3%83%AB%E3%82%AB%E3%83%88%E3%83%BC%E3%83%AA%E3%81%AB%E5%8F%96%E3%82%8A%E7%B5%84%E3%82%93%E3%81%A7%E3%81%BB%E3%81%97%E3%81%84%E3%81%93%E3%81%A8%E3%80%81%E6%9C%9F%E5%BE%85%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AA%E3%81%A9%E3%81%94%E3%81%96%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F%E3%82%89%E3%80%81%E3%81%94%E8%87%AA%E7%94%B1%E3%81%AB%E3%81%8A%E6%9B%B8%E3%81%8D%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82&info=%E6%AC%A1%E5%9B%9E%E3%81%AE%E6%BC%94%E5%A5%8F%E4%BC%9A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%94%E6%A1%88%E5%86%85%E3%82%92%E5%B8%8C%E6%9C%9B%E3%81%95%E3%82%8C%E3%82%8B%E6%96%B9%E3%81%AF%E3%81%94%E8%A8%98%E5%85%A5%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82%7C%5B%22furigana%22%2C%22name%22%2C%22nameKana%22%2C%22email%22%2C%22tel%22%2C%22zip%22%2C%22address%22%5D


URLのエンコード・デコードはここでやる
https://tech-unlimited.com/urlencode.html

URL（日本語）
myapp://import?
id=12345&
title=第10回定期演奏会アンケート&
single=お客様のご年代をお知らせください。|["10代未満","10代","20代","30代","40代","50代","60代","70代","80代以上","その他"]&
multiple=本公演はどちらでお知りになりましたか？|["ポスター","出演者から","SNS(X,Instagram,Facebook)","その他"]&
single=本公演の満足度を5段階評価でお知らせください|["大変良かった","良かった","普通","良くなかった","悪かった"]&
text=本日のご感想をお聞かせください（印象に残った曲、出演者へのメッセージなど）&
text=改善点やオーケストラチェルカトーリに取り組んでほしいこと、期待することなどございましたら、ご自由にお書きください。&
info=次回の演奏会についてご案内を希望される方はご記入ください。|["furigana","name","nameKana","email","tel","zip","address"]

**前提ルール**

- アンケートのIDとタイトルを用意
- &で区切る
- タイプを type=single|multiple|text|info で指定
    - single：単数解答の選択肢
    - multiple：複数回答の選択肢
    - text：自由回答
    - info：個人情報（1つの設問に複数項目を用意）
- 選択肢の内容は JSON配列形式で指定 single=設問文|["選択肢1","選択肢2",...] （推奨）
- 従来のカンマ区切りも後方互換性のためサポート single=設問文|選択肢1,選択肢2,...
- 自由回答はtext=のみ
- 個人情報は項目をJSON配列で指定 info=設問文|["furigana","name",...]
※本番ではクエリの日本語はエンコードした文字列にする

個人情報（info=）の設問は一つの設問に複数の入力項目がある。
以下が「,」区切り、順不同で設定されている
- name：氏名(フルネーム)
- furigana：ふりがな
- email：メールアドレス
- tel：電話番号
- zip：郵便番号
- address：住所

※本番ではクエリの日本語はエンコードした文字列にする

## チェックボックス設問の「その他」の自由回答の検出のフロー
1. チェックボックスの座標を全て検出
2. 座標を元に左上からindexを割り振る
3. 最後のindexがその他になる
4. 単数解答であればチェックがついている最初の選択肢の文字列を保持
5. 複数回答であればチェックがついている全ての選択肢の文字列を保持
6. その他にチェックがついているor全てのチェックボックスにチェックが付いていない場合にその他の（）内の文字検出を行う
7. その他のチェックボックス3つ分右の座標を割り出す（文字検出時にその他を入れないため）
8. 割り出した座標から上に少し、下にチェックボックスの高さと少し、右側を切り取る
9. 文字検出後の文字列から()を除外してその文字列を保持

## 回答検出フロー (single / multiple / text)

以下は実装側で使用している高レベルの検出フローの説明です。詳細実装は `OpenCVWrapper.mm` にあり、UI 側では `CameraView.swift` が結果を表示します。

共通の前処理
- 画像をグレースケール化し、ノイズ低減（Blur）を行う。
- 大津閾値（OTSU）などで二値化し、必要に応じて反転（白黒を反転）する。
- 円検出で設問ごとに切り出した小画像を入力として処理する（円検出・切り取りは既存処理に従う）。

single / multiple（チェックボックス検出）
- 目的: 各選択肢に対応するチェックボックス座標を検出し、選択有無を判定して文字列にマップする。
- 手順:
   1. 二値化結果から水平／垂直方向の線抽出を行う（モルフォロジー: カーネル幅 lWidth=2, 枠の太さに合わせた lineMinWidth=15 を使用）。
   2. 水平マスクと垂直マスクを合成して枠線マスクを作る。
   3. `connectedComponentsWithStats` で候補領域を抽出する。
   4. 幾何学的フィルタを適用（幅・高さ・面積・縁からの余白・概ね正方形など）してチェックボックス候補を絞る。
   5. 候補を上→左の順でソートしてインデックスを割り振る（左上基準で index を付ける）。
   6. 各候補の内部領域（枠内）を見て黒ピクセル比率を計算し、閾値以上ならチェックありと判断（isCheckboxChecked）。
   7. single なら最初に検出されたチェックを採用、multiple なら全チェックを採用して選択肢文字列にマップする。

text（自由記述の枠内文字検出）
- 目的: 設問内の矩形枠（長方形）を検出し、その内部を OCR して一行の文字列として返す。
- 手順:
   1. チェックボックス検出と同じ前処理（グレースケール、二値化、水平／垂直線抽出）を行う。枠の線幅はチェックボックスと同じなので `lineMinWidth=15` を使用する。
   2. 水平／垂直マスクを合成して枠線マスク（imgBinFinal）を作る。
   3. `findContours`（または接続成分）で輪郭／領域候補を抽出する。
   4. 候補に対して幾何学的フィルタを適用する（例: 幅 > 50, 高さ > 20, 面積 > 1000, 画像全体を占めない w < 0.95*cols 等、縦横比の緩い条件）。
   5. フィルタを通った候補の中から面積最大の矩形を選ぶ（ただし画像全体をそのまま選ばないように境界係数で除外する）。
   6. 選ばれた矩形の内側（少し余白を取って）を切り出し、`recognizeTextFromImage:`（Vision）で OCR を実行する。
   7. OCR 結果は改行を削除して 1 行にまとめる（`removeNewlinesFromText:` を使用）。
   8. 候補が見つからない場合は閾値を緩めるか、Hough 直線検出等の代替手法で再試行する。

実装上の主要シンボル／ファイル
- `OpenCVWrapper.mm`:
   - `detectCheckboxes`（チェックボックス検出のロジック）
   - `isCheckboxChecked`（チェック判定）
   - `detectTextAnswerFromImage:`（画像から自由記述を抽出するエントリ）
   - `detectLargestTextBox:`（枠検出関数、モルフォロジー→輪郭抽出→フィルタ）
   - `recognizeTextFromImage:`（Vision による OCR）
   - `removeNewlinesFromText:`（改行を削除して 1 行にする）
- `CameraView.swift`: 検出結果（text の場合の OCR 文字列）を UI に表示する部分を担当。

デバッグ・チューニングのヒント
- 実行ログには検出過程の情報が出力されるようにしています。デバッグ時は以下のログ文字列を探してください:
   - "OpenCVWrapper: detectLargestTextBox - binary nonZero="
   - "OpenCVWrapper: detectLargestTextBox - imgBinH nonZero="
   - "OpenCVWrapper: detectLargestTextBox - imgBinV nonZero="
   - "OpenCVWrapper: detectLargestTextBox - imgBinFinal nonZero="
   - "OpenCVWrapper: detectLargestTextBox - contourCount="
   - "OpenCVWrapper: detectLargestTextBox - contour="（個々の候補のフィルタ通過ログ）
- 枠が検出できない場合: `lineMinWidth`（枠の太さ）を入力画像の実際の線幅にあわせて調整する、または横/縦カーネルのサイズ（lWidth）を変えてみてください。
- connectedComponents が画像全体を返すケースでは `findContours` に切り替えて候補を絞ると安定することが多いです。

このセクションは今後のパラメータ調整や追加のフォールバックを記録するために更新していきます。

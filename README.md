# CSAApp

## 概要
CSAAppは、SwiftUIを使用して開発されたiOSアプリケーションで、アンケートのスキャン、設問タイプの選択、画像処理、文字認識などの機能を提供します。以下に画面ごとの機能とアプリのフローを説明します。

---

## 画面ごとの機能

### 1. **ContentView**
- アプリのメイン画面。
- 保存されたアンケートデータ（`Item`）のリストを表示。
- 各アイテムにはタイムスタンプと選択された設問タイプが表示される。
- アイテムをタップするとカメラ画面（`CameraView`）が開く。
- 新しいアイテムを追加するためのボタンを提供し、設問タイプ選択画面（`QuestionTypeSelectionView`）を表示。

### 2. **QuestionTypeSelectionView**
- 設問タイプ（単数回答、複数回答、自由記述）を選択する画面。
- 選択した設問タイプをリスト形式で表示。
- 設問タイプを削除する機能を提供。
- 完了ボタンで選択内容を確定し、`ContentView`に戻る。

### 3. **CameraView**
- カメラプレビューを表示し、リアルタイムで矩形検出を行う。
- 自動キャプチャ機能を提供し、検出された画像を保存。
- キャプチャした画像を加工（グレースケール変換、円検出、切り取り）し、プレビュー表示。
- サンプル画像を読み込む機能を提供。
- キャプチャした画像のプレビューを全画面表示可能。

---

## 機能のフロー

1. **アンケートデータの作成**
   - `ContentView`で「+」ボタンを押下。
   - `QuestionTypeSelectionView`で設問タイプを選択し、完了ボタンを押す。
   - 新しいアイテムがリストに追加されて`CameraView`が自動で開く。

2. **アンケートのスキャン**
   - `ContentView`でアイテムをタップして`CameraView`を開く。
   - カメラプレビューでアンケート用紙をスキャン。
   - 自動キャプチャで画像を取得（手動キャプチャ機能を実装するかは要検討）。
   - 取得した画像を加工し、切り取られた設問画像をプレビュー。

3. **画像処理と文字認識**
   - OpenCVを使用して画像を加工（リサイズ、グレースケール、二値化、ノイズ除去など）。
   - 円検出を行い、設問ごとに画像を切り取り。
   - Visionフレームワークを使用して文字認識を実施。

4. **プレビューと確認**
   - キャプチャした画像や切り取られた設問画像をプレビュー。
   - 必要に応じて再スキャンや再開を実行。

---

## 使用技術
- **SwiftUI**: UI構築
- **MVVMパターン**: アーキテクチャ
- **OpenCV**: 画像処理（円検出、ノイズ除去など）
- **Visionフレームワーク**: 文字認識
- **Combine**: データバインディングとリアクティブプログラミング
- **CoreGraphics**: 矩形検出と画像操作

---

## 今後の機能実装
- 設問タイプを選択し、完了ボタンを押すと、`CameraView`の前に未記入のアンケートを読み取って、単数解答、複数回答の選択肢の文字列を設定する機能を実装する。
- Web側でアンケートのフォーマットを作成した後にアプリを開く下記フォーマットのURLを作成して、そのURLからアプリを開いたときにフォーマットと選択肢の文などを自動反映できるようにする。
- 画像を設問ごとに切り取ったあと、事前に選択した設問タイプの順番に解答内容を集計する。
- お客様情報（名前、メールアドレスなど）の設問タイプを作成する（どういったフォーマットにするか考える）

## URLの仕様
URLの例
myapp://import?single=10%E4%BB%A3%E6%9C%AA%E6%BA%80,20%E4%BB%A3,30%E4%BB%A3,40%E4%BB%A3,50%E4%BB%A3,60%E4%BB%A3,70%E4%BB%A3,80%E4%BB%A3%E4%BB%A5%E4%B8%8A&multi=%E3%83%9D%E3%82%B9%E3%82%BF%E3%83%BC,%E5%87%BA%E6%BC%94%E8%80%85%E3%81%8B%E3%82%89,SNS(X,Instagram,Facebook),%E3%81%9D%E3%81%AE%E4%BB%96&single=%E5%A4%A7%E5%A4%89%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F,%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F,%E6%99%AE%E9%80%9A,%E8%89%AF%E3%81%8F%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F,%E6%82%AA%E3%81%8B%E3%81%A3%E3%81%9F&text=&text=&info=furigana,name,nameKana,email,tel,zip,address

URLのエンコード・デコードはここでやる
https://tech-unlimited.com/urlencode.html

https://example.com/form?
single=10代未満,20代,30代,40代,50代,60代,70代,80代以上&
multi=ポスター,出演者から,SNS(X,Instagram,Facebook),その他&
single=大変良かった,良かった,普通,良くなかった,悪かった&
text=&
text=&
info=furigana,name,nameKana,email,tel,zip,address

**前提ルール**

- 設問は&で区切る
- タイプを type=single|multi|text|info で指定
    - single：単数解答の選択肢
    - multi：複数回答の選択肢
    - text：自由回答
    - info：個人情報（1つの設問に複数項目を用意）
- 選択肢の内容は single=選択肢1,選択肢2,... で指定
- 自由回答はtext=のみ
- 個人情報は項目を選択肢1,選択肢2,... で指定

※本番ではクエリの日本語はエンコードした文字列にする

## チェックボックス設問の「その他」の自由回答の検出のフロー
1. チェックボックスの座標を全て検出
2. 座標を元に左上からindexを割り振る
3. 最後のindexがその他になる
4. 単数解答であればチェックがついている最初の選択肢の文字列を保持
5. 複数回答であればチェックがついている全ての選択肢の文字列を保持
6. その他にチェックがついているor全てのチェックボックスにチェックが付いていない場合にその他の（）内の文字検出を行う
7. その他のチェックボックス3つ分右の座標を割り出す（文字検出時にその他を入れないため）
8. 割り出した座標から上に少し、下にチェックボックスの高さと少し、右側を切り取る
9. 文字検出後の文字列から()を除外してその文字列を保持

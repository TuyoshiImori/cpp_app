# CSAApp

## 概要
CSAAppは、SwiftUIを使用して開発されたiOSアプリケーションで、アンケートのスキャン、設問タイプの選択、画像処理、文字認識などの機能を提供します。以下に画面ごとの機能とアプリのフローを説明します。

---

## 画面ごとの機能

### 1. **ContentView**
- アプリのメイン画面。
- 保存されたアンケートデータ（`Item`）のリストを表示。
- 各アイテムにはタイムスタンプと選択された設問タイプが表示される。
- アイテムをタップするとカメラ画面（`CameraView`）が開く。
 - 新しいアイテムは外部からの URL インポート（例: `myapp://import?...`）によって作成されます。

### 2. **CameraView**
- カメラプレビューを表示し、リアルタイムで矩形検出を行う。
- 自動キャプチャ機能を提供し、検出された画像を保存。
- キャプチャした画像を加工（グレースケール変換、円検出、切り取り）し、プレビュー表示。
- サンプル画像を読み込む機能を提供。
- キャプチャした画像のプレビューを全画面表示可能。

---

## 機能のフロー

1. **アンケートデータの作成**
   - Web 側でアンケートのフォーマット（設問文・選択肢）を作成し、所定のクエリフォーマットでアプリを開く URL（例: `myapp://import?...`）を用意する。
   - その URL でアプリを開くと、アプリ側でパースして `Item` が自動的に作成されます（設問文と選択肢を含む）。
   - 必要に応じて `CameraView` を開き、アンケート用紙のスキャンや画像処理を行います。

2. **アンケートのスキャン**
   - `ContentView`でアイテムをタップして`CameraView`を開く。
   - カメラプレビューでアンケート用紙をスキャン。
   - 自動キャプチャで画像を取得（手動キャプチャ機能を実装するかは要検討）。
   - 取得した画像を加工し、切り取られた設問画像をプレビュー。

3. **画像処理と文字認識**
   - OpenCVを使用して画像を加工（リサイズ、グレースケール、二値化、ノイズ除去など）。
   - 円検出を行い、設問ごとに画像を切り取り。
   - Visionフレームワークを使用して文字認識を実施。

4. **プレビューと確認**
   - キャプチャした画像や切り取られた設問画像をプレビュー。
   - 必要に応じて再スキャンや再開を実行。

---

## 使用技術
- **SwiftUI**: UI構築
- **MVVMパターン**: アーキテクチャ
- **OpenCV**: 画像処理（円検出、ノイズ除去など）
- **Visionフレームワーク**: 文字認識
- **Combine**: データバインディングとリアクティブプログラミング
- **CoreGraphics**: 矩形検出と画像操作

---

## 今後の機能実装
- URLにアンケートIDとタイトルを追加して、同じIDのアンケートが複数追加されないようにする
- 画像を設問ごとに切り取ったあと、事前に選択した設問タイプの順番に解答内容を集計する。

## URLの仕様
URLの例
myapp://import?id=12345&title=%E7%AC%AC10%E5%9B%9E%E5%AE%9A%E6%9C%9F%E6%BC%94%E5%A5%8F%E4%BC%9A%E3%82%A2%E3%83%B3%E3%82%B1%E3%83%BC%E3%83%88&single=%E3%81%8A%E5%AE%A2%E6%A7%98%E3%81%AE%E3%81%94%E5%B9%B4%E4%BB%A3%E3%82%92%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82%7C10%E4%BB%A3%E6%9C%AA%E6%BA%80%2C10%E4%BB%A3%2C20%E4%BB%A3%2C30%E4%BB%A3%2C40%E4%BB%A3%2C50%E4%BB%A3%2C60%E4%BB%A3%2C70%E4%BB%A3%2C80%E4%BB%A3%E4%BB%A5%E4%B8%8A%2C%E3%81%9D%E3%81%AE%E4%BB%96&multiple=%E6%9C%AC%E5%85%AC%E6%BC%94%E3%81%AF%E3%81%A9%E3%81%A1%E3%82%89%E3%81%A7%E3%81%8A%E7%9F%A5%E3%82%8A%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%97%E3%81%9F%E3%81%8B%EF%BC%9F%7C%E3%83%9D%E3%82%B9%E3%82%BF%E3%83%BC%2C%E5%87%BA%E6%BC%94%E8%80%85%E3%81%8B%E3%82%89%2CSNS%28X%2CInstagram%2CFacebook%29%2C%E3%81%9D%E3%81%AE%E4%BB%96&single=%E6%9C%AC%E5%85%AC%E6%BC%94%E3%81%AE%E6%BA%80%E8%B6%B3%E5%BA%A6%E3%82%925%E6%AE%B5%E9%9A%8E%E8%A9%95%E4%BE%A1%E3%81%A7%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%7C%E5%A4%A7%E5%A4%89%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F%2C%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F%2C%E6%99%AE%E9%80%9A%2C%E8%89%AF%E3%81%8F%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%2C%E6%82%AA%E3%81%8B%E3%81%A3%E3%81%9F&text=%E6%9C%AC%E6%97%A5%E3%81%AE%E3%81%94%E6%84%9F%E6%83%B3%E3%82%92%E3%81%8A%E8%81%9E%E3%81%8B%E3%81%9B%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%EF%BC%88%E5%8D%B0%E8%B1%A1%E3%81%AB%E6%AE%8B%E3%81%A3%E3%81%9F%E6%9B%B2%E3%80%81%E5%87%BA%E6%BC%94%E8%80%85%E3%81%B8%E3%81%AE%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%81%AA%E3%81%A9%EF%BC%89&text=%E6%94%B9%E5%96%84%E7%82%B9%E3%82%84%E3%82%AA%E3%83%BC%E3%82%B1%E3%82%B9%E3%83%88%E3%83%A9%E3%83%81%E3%82%A7%E3%83%AB%E3%82%AB%E3%83%88%E3%83%BC%E3%83%AA%E3%81%AB%E5%8F%96%E3%82%8A%E7%B5%84%E3%82%93%E3%81%A7%E3%81%BB%E3%81%97%E3%81%84%E3%81%93%E3%81%A8%E3%80%81%E6%9C%9F%E5%BE%85%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AA%E3%81%A9%E3%81%94%E3%81%96%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F%E3%82%89%E3%80%81%E3%81%94%E8%87%AA%E7%94%B1%E3%81%AB%E3%81%8A%E6%9B%B8%E3%81%8D%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82&info=%E6%AC%A1%E5%9B%9E%E3%81%AE%E6%BC%94%E5%A5%8F%E4%BC%9A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%94%E6%A1%88%E5%86%85%E3%82%92%E5%B8%8C%E6%9C%9B%E3%81%95%E3%82%8C%E3%82%8B%E6%96%B9%E3%81%AF%E3%81%94%E8%A8%98%E5%85%A5%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82%7Cfurigana%2Cname%2CnameKana%2Cemail%2Ctel%2Czip%2Caddress


URLのエンコード・デコードはここでやる
https://tech-unlimited.com/urlencode.html

myapp://import?
id=12345&
title=第10回定期演奏会アンケート&
single=お客様のご年代をお知らせください。|10代未満,10代,20代,30代,40代,50代,60代,70代,80代以上,その他&
multiple=本公演はどちらでお知りになりましたか？|ポスター,出演者から,SNS(X,Instagram,Facebook),その他&
single=本公演の満足度を5段階評価でお知らせください|大変良かった,良かった,普通,良くなかった,悪かった&
text=本日のご感想をお聞かせください（印象に残った曲、出演者へのメッセージなど）&
text=改善点やオーケストラチェルカトーリに取り組んでほしいこと、期待することなどございましたら、ご自由にお書きください。&
info=次回の演奏会についてご案内を希望される方はご記入ください。|furigana,name,nameKana,email,tel,zip,address

**前提ルール**

- アンケートのIDとタイトルを用意
- &で区切る
- タイプを type=single|multiple|text|info で指定
    - single：単数解答の選択肢
    - multiple：複数回答の選択肢
    - text：自由回答
    - info：個人情報（1つの設問に複数項目を用意）
- 選択肢の内容は single=選択肢1,選択肢2,... で指定
- 自由回答はtext=のみ
- 個人情報は項目を選択肢1,選択肢2,... で指定
※本番ではクエリの日本語はエンコードした文字列にする

個人情報（info=）の設問は一つの設問に複数の入力項目がある。
以下が「,」区切り、順不同で設定されている
- name：氏名(フルネーム)
- furigana：ふりがな
- email：メールアドレス
- tel：電話番号
- zip：郵便番号
- address：住所

※本番ではクエリの日本語はエンコードした文字列にする

## チェックボックス設問の「その他」の自由回答の検出のフロー
1. チェックボックスの座標を全て検出
2. 座標を元に左上からindexを割り振る
3. 最後のindexがその他になる
4. 単数解答であればチェックがついている最初の選択肢の文字列を保持
5. 複数回答であればチェックがついている全ての選択肢の文字列を保持
6. その他にチェックがついているor全てのチェックボックスにチェックが付いていない場合にその他の（）内の文字検出を行う
7. その他のチェックボックス3つ分右の座標を割り出す（文字検出時にその他を入れないため）
8. 割り出した座標から上に少し、下にチェックボックスの高さと少し、右側を切り取る
9. 文字検出後の文字列から()を除外してその文字列を保持
